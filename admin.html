<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Amazon Control</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;600&display=swap');
        body { font-family: 'Kanit', sans-serif; background: #1b3022; color: white; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { background: rgba(0, 0, 0, 0.5); padding: 30px; border-radius: 20px; border: 1px solid #a2cf6e; width: 95%; max-width: 1000px; }
        h2 { text-align: center; color: #a2cf6e; margin-bottom: 20px; }
        table { width: 100%; border-collapse: collapse; background: rgba(255, 255, 255, 0.05); }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #5d8a39; }
        th { background: #2d5a27; color: #a2cf6e; }
        .btn-del { background: #ff5252; color: white; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; }
        .btn-edit { background: #ffc107; color: black; border: none; padding: 6px 10px; border-radius: 5px; cursor: pointer; margin-right: 5px; }
        .btn-back { margin-bottom: 20px; background: none; color: #a2cf6e; border: 1px solid #a2cf6e; padding: 10px 20px; cursor: pointer; border-radius: 20px; text-decoration: none; display: inline-block; }
        .loading { text-align: center; padding: 20px; color: #a2cf6e; }
    </style>
</head>
<body>
    <a href="index.html" class="btn-back">‚Üê ‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô</a>
    <div class="container">
        <h2>üõ† ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏®‡∏¥‡∏©‡∏¢‡πå‡πÄ‡∏Å‡πà‡∏≤ (Admin)</h2>
        <div style="overflow-x:auto;">
            <table>
                <thead>
                    <tr>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th>‡∏£‡∏∏‡πà‡∏ô</th>
                        <th>‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå</th>
                        <th>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£</th>
                    </tr>
                </thead>
                <tbody id="data-list">
                    <tr><td colspan="5" class="loading">‚è≥ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyB6ZhCyYP6T5STcQDoOv4lh78oWLgDxb2Ow6066ncLA4KppFD77fqeL-dTNp7UiRk/exec';

        async function renderTable() {
            const tbody = document.getElementById('data-list');
            try {
                const response = await fetch(SCRIPT_URL);
                const rawData = await response.json();
                tbody.innerHTML = '';
                
                if (!rawData || rawData.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;">üçÉ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏û‡∏á‡πÑ‡∏û‡∏£</td></tr>';
                    return;
                }

                // ‡∏Ç‡πâ‡∏≤‡∏°‡πÅ‡∏ñ‡∏ß‡πÅ‡∏£‡∏Å‡∏ñ‡πâ‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏±‡∏ß‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "‡∏ä‡∏∑‡πà‡∏≠", "‡∏£‡∏∏‡πà‡∏ô")
                const data = (Array.isArray(rawData[0]) && isNaN(rawData[0][1])) ? rawData.slice(1) : rawData;

                data.forEach((item, index) => {
                    let date = "-", name = "-", batch = "-", phone = "-";

                    if (Array.isArray(item)) {
                        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥: ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà, ‡∏ä‡πà‡∏≠‡∏á‡πÑ‡∏´‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏ä‡∏∑‡πà‡∏≠
                        item.forEach(val => {
                            let s = String(val);
                            if (s.includes('-') && s.includes('T')) {
                                let d = new Date(val);
                                date = d.toLocaleDateString('th-TH') + ' ' + d.toLocaleTimeString('th-TH', {hour:'2-digit', minute:'2-digit'});
                            }
                        });
                        
                        // ‡∏Å‡∏é‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô: ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏ß‡πâ‡∏≤‡∏á‡∏Ç‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏ä‡πà‡∏≠‡∏á 0)
                        if (date !== "-") {
                            name = item[1] || "-";
                            batch = item[2] || "-";
                            phone = item[3] || "-";
                        } else {
                            name = item[0] || "-";
                            batch = item[1] || "-";
                            phone = item[2] || "-";
                        }
                    }

                    tbody.innerHTML += `
                        <tr>
                            <td style="font-size:0.85em; color:#888;">${date}</td>
                            <td>**${name}**</td>
                            <td>${batch}</td>
                            <td>${phone}</td>
                            <td>
                                <button class="btn-edit" onclick="editData(${index}, '${name}', '${batch}', '${phone}')">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                                <button class="btn-del" onclick="deleteData(${index})">‡∏•‡∏ö</button>
                            </td>
                        </tr>
                    `;
                });
            } catch (e) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; color:red;">‚ùå ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£ Deploy ‡∏Ç‡∏≠‡∏á Google Script)</td></tr>';
            }
        }

        async function deleteData(idx) {
            if(!confirm("‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ?")) return;
            await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body: JSON.stringify({action:'delete', index:idx}) });
            alert("‡∏•‡∏ö‡πÅ‡∏•‡πâ‡∏ß! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠ 2 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ");
            setTimeout(renderTable, 2000);
        }

        async function editData(idx, n, b, p) {
            const nn = prompt("‡∏ä‡∏∑‡πà‡∏≠‡πÉ‡∏´‡∏°‡πà:", n), nb = prompt("‡∏£‡∏∏‡πà‡∏ô‡πÉ‡∏´‡∏°‡πà:", b), np = prompt("‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà:", p);
            if(!nn || !nb || !np) return;
            await fetch(SCRIPT_URL, { method:'POST', mode:'no-cors', body: JSON.stringify({action:'edit', index:idx, name:nn, batch:nb, phone:np}) });
            alert("‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß!");
            setTimeout(renderTable, 2000);
        }

        window.onload = renderTable;
    </script>
</body>
</html>
